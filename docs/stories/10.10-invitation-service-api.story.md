# Story 10.10: Invitation Service & API

**Story ID**: 10.10
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P1 (High)
**Effort**: 13 Story Points

## Story
**As a** system owner
**I want** to invite users via email with role assignment
**So that** I can add team members securely

## Acceptance Criteria
1. Create `apps/api/src/services/invitationService.ts`
2. Implement `createInvitation(email, role, invitedBy)` method
3. Generate secure invitation token using crypto.randomBytes(32)
4. Set expiry to 7 days from creation
5. Send email with registration link including token
6. Implement `validateInvitation(token)` method
7. Implement `acceptInvitation(token, password, firstName, lastName)` method
8. Create POST /api/invitations endpoint (system_owner only)
9. Create GET /api/invitations/validate/:token endpoint (public)
10. Create POST /api/invitations/accept endpoint (public)
11. Mark invitation as accepted after successful registration
12. Prevent reuse of accepted/expired invitations

## Technical Notes
**invitationService.ts:**
```typescript
export class InvitationService {
  async createInvitation(email: string, role: string, invitedBy: string): Promise<string> {
    // Check if user already exists
    const existingUser = await query('SELECT id FROM users WHERE email = $1', [email]);
    if (existingUser.rows.length > 0) {
      throw createError('User with this email already exists', 400);
    }

    // Generate secure token
    const token = crypto.randomBytes(32).toString('hex');
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 7);

    // Store invitation
    await query(
      `INSERT INTO user_invitations (email, role, token, expires_at, invited_by)
       VALUES ($1, $2, $3, $4, $5)`,
      [email, role, token, expiresAt, invitedBy]
    );

    // Send email
    await emailService.sendInvitation(email, token, role);

    return token;
  }

  async validateInvitation(token: string) {
    const result = await query(
      `SELECT * FROM user_invitations
       WHERE token = $1 AND accepted_at IS NULL AND expires_at > NOW()`,
      [token]
    );

    if (result.rows.length === 0) {
      throw createError('Invalid or expired invitation', 400);
    }

    return result.rows[0];
  }

  async acceptInvitation(token: string, password: string, firstName: string, lastName: string) {
    const invitation = await this.validateInvitation(token);

    // Create user with invited role
    const user = await authService.register(
      invitation.email,
      password,
      firstName,
      lastName,
      invitation.role,
      'invitation'
    );

    // Mark invitation as accepted
    await query(
      'UPDATE user_invitations SET accepted_at = NOW() WHERE token = $1',
      [token]
    );

    // Log activity
    await activityLogService.logActivity(user.id, 'user_invited', 'invitation', null, null);

    return user;
  }
}
```

**Email Template:**
```html
<h2>You've been invited to join Partman</h2>
<p>Hi,</p>
<p>You've been invited to join Partman as a <strong>{role}</strong>.</p>
<p>Click the link below to complete your registration:</p>
<a href="{FRONTEND_URL}/register?token={token}">Accept Invitation</a>
<p>This invitation expires in 7 days.</p>
```

## Tasks
- [ ] Create invitationService.ts with InvitationService class
- [ ] Implement createInvitation method with crypto token generation
- [ ] Implement validateInvitation method
- [ ] Implement acceptInvitation method
- [ ] Create emailService.sendInvitation method
- [ ] Create POST /api/invitations endpoint with authorize(['system_owner'])
- [ ] Create GET /api/invitations/validate/:token endpoint
- [ ] Create POST /api/invitations/accept endpoint
- [ ] Add email validation (check existing users)
- [ ] Add role validation (valid role enum)
- [ ] Handle duplicate invitation attempts
- [ ] Write unit tests for invitation flow
- [ ] Test email delivery
- [ ] Test token expiry logic
- [ ] Test invitation reuse prevention

## Testing
- [ ] createInvitation generates unique token
- [ ] Invitation email sent successfully
- [ ] validateInvitation rejects expired tokens
- [ ] validateInvitation rejects accepted tokens
- [ ] acceptInvitation creates user with correct role
- [ ] Cannot invite existing user email
- [ ] Cannot reuse accepted invitation
- [ ] System owner can create invitations
- [ ] Non-system_owner cannot create invitations
- [ ] All endpoints return correct error messages

## Definition of Done
- Invitation service fully functional
- Email delivery working
- All security checks in place
- Tests passing
- Documentation complete

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### File List
- `apps/api/src/services/invitationService.ts`
- `apps/api/src/services/emailService.ts`
- `apps/api/src/routes/invitations.ts`
- `apps/api/src/routes/index.ts` (add invitation routes)

### Change Log
[To be filled during implementation]
