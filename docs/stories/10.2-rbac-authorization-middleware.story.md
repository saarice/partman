# Story 10.2: RBAC Authorization Middleware

**Story ID**: 10.2
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P0 (Blocker)
**Effort**: 8 Story Points

## Story
**As a** developer
**I want** role-based authorization middleware
**So that** API endpoints are protected based on user roles

## Acceptance Criteria
1. Create `apps/api/src/middleware/authorization.ts`
2. Export `authorize(allowedRoles: string[])` function
3. Returns 403 Forbidden if role not in allowedRoles
4. Returns 401 Unauthorized if req.user not present
5. Authorization failures logged with user_id, path, role
6. Unit tests cover all scenarios (valid role, invalid role, no user)
7. Integration tests verify protected endpoints work correctly

## Technical Notes
**Middleware Signature:**
```typescript
export const authorize = (allowedRoles: string[]) => {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user) {
      throw createError('Authentication required', 401);
    }
    if (!allowedRoles.includes(req.user.role)) {
      logger.warn(`Unauthorized access: user=${req.user.id}, role=${req.user.role}, path=${req.path}`);
      throw createError(`Insufficient permissions. Requires: ${allowedRoles.join(' or ')}`, 403);
    }
    next();
  };
};
```

**Usage Examples:**
```typescript
router.get('/admin/users', authenticate, authorize(['system_owner']), getUsersHandler);
router.put('/partnerships/:id', authenticate, authorize(['system_owner', 'vp', 'sales_manager']), updateHandler);
```

## Tasks
- [ ] Create apps/api/src/middleware/authorization.ts
- [ ] Implement authorize(allowedRoles) function
- [ ] Add proper TypeScript types (AuthRequest interface)
- [ ] Implement 401 check for missing user
- [ ] Implement 403 check for insufficient role
- [ ] Add logger.warn for authorization failures
- [ ] Write unit tests for all scenarios
- [ ] Write integration tests with sample routes
- [ ] Apply middleware to existing protected routes
- [ ] Document middleware usage in README

## Testing
**Unit Tests:**
- [ ] Valid role allows access (next() called)
- [ ] Invalid role returns 403 Forbidden
- [ ] No user (req.user null) returns 401 Unauthorized
- [ ] Multiple allowed roles work correctly
- [ ] Error response format matches specification

**Integration Tests:**
- [ ] System owner can access /admin/users
- [ ] VP cannot access /admin/users (403)
- [ ] Unauthenticated request returns 401
- [ ] Sales rep can access allowed endpoints
- [ ] Viewer cannot edit data (403)

## Definition of Done
- Middleware applied to all protected routes
- 100% test coverage for authorization.ts
- All integration tests passing
- Security audit confirms proper role enforcement
- Authorization failures logged correctly
- Documentation updated

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### Debug Log References
[To be filled during implementation]

### Completion Notes
- [ ] Middleware created and tested
- [ ] All routes protected correctly
- [ ] Tests passing

### File List
- `apps/api/src/middleware/authorization.ts`
- `apps/api/src/tests/authorization.test.ts`

### Change Log
[To be filled during implementation]
