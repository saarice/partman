# Story 11.2: Remove Security Vulnerabilities & Hardcoded Bypasses

## Status
Ready for Development

## Epic
Epic 11: Production Readiness & Technical Debt Resolution

## Priority
🔴 **CRITICAL** - Security Vulnerability

## Story Points
3 points (1 day)

---

## Story

**As a** Security-Conscious Developer
**I want** to remove all hardcoded authentication bypasses and implement proper environment validation
**So that** unauthorized users cannot access the system and production deployments are secure

---

## Context

**Security Vulnerability Identified** (2025-10-18 Analysis):

**Location**: `apps/api/src/middleware/authentication.ts` lines 38-46

```typescript
// 🚨 CRITICAL SECURITY VULNERABILITY
if (token === 'mock-jwt-token-system-owner') {
  req.user = {
    id: 'system-owner-1',
    email: 'admin@partman.com',
    role: 'system_owner' as UserRole,
    permissions: ['*'],  // FULL SYSTEM ACCESS!
    organizationId: 'default'
  };
  return next();  // Bypasses all authentication
}
```

**Severity**: CRITICAL
**CVE Risk**: Authentication Bypass
**Attack Vector**: Anyone knowing this token gets full system access
**Exploitability**: Trivial (hardcoded in source code)

**Additional Security Issues**:
1. Default JWT secret in code: `dev_jwt_secret_change_in_production`
2. No environment variable validation on startup
3. Development bypasses not guarded by `NODE_ENV`
4. No secrets rotation strategy

---

## Acceptance Criteria

### 1. Mock Authentication Token Removed
- [ ] Hardcoded token check completely removed from production code
- [ ] Authentication flow requires valid JWT for all requests
- [ ] No bypass mechanisms in authentication middleware
- [ ] Code review confirms no other hardcoded credentials

### 2. Environment Variable Validation Implemented
- [ ] Server fails to start if required env vars missing
- [ ] Required variables: `DATABASE_URL`, `JWT_SECRET`, `REDIS_URL`
- [ ] JWT_SECRET must be non-default value in production
- [ ] Clear error messages indicate which variables are missing
- [ ] Validation runs before server initialization

### 3. Development-Only Code Properly Guarded
- [ ] Test fixtures only available when `NODE_ENV=test`
- [ ] Mock data only loaded when `NODE_ENV=development`
- [ ] Debug endpoints disabled in production
- [ ] Environment checks use strict equality (`===`)

### 4. Security Audit Completed
- [ ] No hardcoded credentials in codebase
- [ ] No authentication bypasses in any middleware
- [ ] All secrets loaded from environment variables
- [ ] `.env.example` files don't contain real secrets
- [ ] `.gitignore` includes all secret files

---

## Tasks / Subtasks

### Task 1: Remove Mock Authentication Token (30 minutes)

**Step 1: Remove hardcoded bypass**
```typescript
// apps/api/src/middleware/authentication.ts

// BEFORE (VULNERABLE):
export const authenticate = (req: Request, res: Response, next: NextFunction) => {
  const authHeader = req.headers.authorization;
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return next(createError('Access token required', 401));
  }

  try {
    // 🚨 DELETE THIS SECTION
    if (token === 'mock-jwt-token-system-owner') {
      req.user = {
        id: 'system-owner-1',
        email: 'admin@partman.com',
        role: 'system_owner' as UserRole,
        permissions: ['*'],
        organizationId: 'default'
      };
      return next();
    }
    // 🚨 END DELETE

    const secret = process.env.JWT_SECRET || 'dev_jwt_secret_change_in_production';
    const decoded = jwt.verify(token, secret) as JwtPayload;
    // ... rest of code
  }
};

// AFTER (SECURE):
export const authenticate = (req: Request, res: Response, next: NextFunction) => {
  const authHeader = req.headers.authorization;
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return next(createError('Access token required', 401));
  }

  try {
    const secret = process.env.JWT_SECRET;
    if (!secret) {
      throw new Error('JWT_SECRET not configured');
    }

    const decoded = jwt.verify(token, secret) as JwtPayload;

    req.user = {
      id: decoded.userId,
      email: decoded.email,
      role: decoded.role,
      permissions: decoded.permissions,
      organizationId: decoded.organizationId || 'default'
    };

    next();
  } catch (error) {
    next(createError('Invalid or expired token', 401));
  }
};
```

**Step 2: Update tests to use real authentication**
- [ ] Create test fixture for generating valid JWT tokens
- [ ] Update integration tests to use fixture tokens
- [ ] Remove any references to `mock-jwt-token-system-owner` in tests

### Task 2: Implement Environment Validation (1-2 hours)

**Create environment validator**:
```typescript
// apps/api/src/config/env.ts

interface RequiredEnvVars {
  DATABASE_URL: string;
  REDIS_URL: string;
  JWT_SECRET: string;
  FRONTEND_URL: string;
  NODE_ENV: 'development' | 'production' | 'test';
}

export class EnvironmentValidator {
  private static readonly REQUIRED_VARS = [
    'DATABASE_URL',
    'REDIS_URL',
    'JWT_SECRET',
    'FRONTEND_URL',
    'NODE_ENV'
  ];

  private static readonly FORBIDDEN_PRODUCTION_VALUES = {
    JWT_SECRET: [
      'dev_jwt_secret_change_in_production',
      'secret',
      'jwt_secret',
      'change_me'
    ]
  };

  static validate(): RequiredEnvVars {
    const missing: string[] = [];
    const invalid: string[] = [];

    // Check for missing variables
    this.REQUIRED_VARS.forEach(varName => {
      if (!process.env[varName]) {
        missing.push(varName);
      }
    });

    if (missing.length > 0) {
      console.error('❌ Missing required environment variables:');
      missing.forEach(v => console.error(`   - ${v}`));
      console.error('\n💡 Copy .env.example to .env and update values');
      process.exit(1);
    }

    // Check for insecure values in production
    if (process.env.NODE_ENV === 'production') {
      Object.entries(this.FORBIDDEN_PRODUCTION_VALUES).forEach(([key, forbiddenValues]) => {
        const value = process.env[key];
        if (value && forbiddenValues.includes(value)) {
          invalid.push(`${key} (using default/insecure value)`);
        }
      });

      if (invalid.length > 0) {
        console.error('❌ Insecure environment variable values in production:');
        invalid.forEach(v => console.error(`   - ${v}`));
        console.error('\n🔒 Generate secure secrets before deploying');
        process.exit(1);
      }
    }

    console.log('✅ Environment validation passed');
    return process.env as RequiredEnvVars;
  }

  static getSecureJwtSecret(): string {
    const secret = process.env.JWT_SECRET;

    if (!secret) {
      throw new Error('JWT_SECRET environment variable is required');
    }

    if (process.env.NODE_ENV === 'production') {
      if (secret.length < 32) {
        throw new Error('JWT_SECRET must be at least 32 characters in production');
      }
    }

    return secret;
  }
}
```

**Update server initialization**:
```typescript
// apps/api/src/server.ts

import { EnvironmentValidator } from './config/env.js';

// Validate environment BEFORE any other initialization
EnvironmentValidator.validate();

dotenv.config();

const app = express();
// ... rest of server setup
```

### Task 3: Guard Development-Only Code (30 minutes)

**Identify and guard development code**:
- [ ] Sample data insertion in `server.ts`
- [ ] Debug endpoints
- [ ] Verbose error messages
- [ ] Development-only CORS settings

```typescript
// apps/api/src/server.ts

// BEFORE:
server.listen(PORT, async () => {
  logger.info(`🚀 Server running on port ${PORT}`);

  // 🚨 RUNS IN PRODUCTION!
  try {
    await insertSampleData();
  } catch (error) {
    logger.error('Failed to insert sample data:', error);
  }
});

// AFTER:
server.listen(PORT, async () => {
  logger.info(`🚀 Server running on port ${PORT}`);

  // ✅ Only in development
  if (process.env.NODE_ENV === 'development') {
    try {
      await insertSampleData();
      logger.info('📊 Sample data inserted');
    } catch (error) {
      logger.error('Failed to insert sample data:', error);
    }
  }
});
```

### Task 4: Security Audit (1 hour)

**Scan codebase for security issues**:
```bash
# 1. Search for hardcoded credentials
grep -r "password.*=.*['\"]" apps/api/src apps/web/src
grep -r "secret.*=.*['\"]" apps/api/src apps/web/src
grep -r "api.*key.*=.*['\"]" apps/api/src apps/web/src
grep -r "token.*=.*['\"]" apps/api/src apps/web/src

# 2. Search for authentication bypasses
grep -r "if.*SKIP\|if.*BYPASS\|if.*MOCK" apps/api/src

# 3. Search for development-only code not guarded
grep -r "NODE_ENV" apps/api/src | grep -v "process.env.NODE_ENV === 'development'"

# 4. Check .gitignore
cat .gitignore | grep -E "\.env$|secrets|credentials"

# 5. Run npm audit
npm audit --audit-level=moderate
```

**Audit Checklist**:
- [ ] No hardcoded passwords, secrets, or API keys
- [ ] No authentication bypasses
- [ ] All development code guarded by `NODE_ENV`
- [ ] `.env` files in `.gitignore`
- [ ] `.env.example` files don't contain real secrets
- [ ] No high/critical npm vulnerabilities

### Task 5: Update Documentation (30 minutes)

**Update environment setup docs**:
- [ ] Document all required environment variables
- [ ] Add environment variable validation to README
- [ ] Create production deployment checklist
- [ ] Add security best practices section

```markdown
## Environment Variables

### Required Variables

All environments require these variables:

- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string
- `JWT_SECRET` - Secret for JWT signing (min 32 chars in production)
- `FRONTEND_URL` - Frontend application URL
- `NODE_ENV` - Environment: development | production | test

### Generating Secure Secrets

**DO NOT use default secrets in production!**

Generate a secure JWT secret:
```bash
# Generate 32-byte random secret
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### Production Deployment Checklist

- [ ] All environment variables set
- [ ] JWT_SECRET is unique and at least 32 characters
- [ ] DATABASE_URL points to production database
- [ ] NODE_ENV=production
- [ ] No .env file committed to git
- [ ] Server starts without errors
```

---

## Testing

### Manual Security Testing

**Test 1: Mock token doesn't work**
```bash
# Attempt to use mock token
curl -H "Authorization: Bearer mock-jwt-token-system-owner" \
  http://localhost:3001/api/dashboard

# Expected: 401 Unauthorized
# {"status":"error","message":"Invalid or expired token"}
```

**Test 2: Server fails without required env vars**
```bash
# Remove required env var
unset JWT_SECRET

# Start server
npm run dev

# Expected: Server exits with error
# ❌ Missing required environment variables:
#    - JWT_SECRET
```

**Test 3: Server rejects default JWT secret in production**
```bash
# Set production mode with default secret
NODE_ENV=production JWT_SECRET=dev_jwt_secret_change_in_production npm run dev

# Expected: Server exits with error
# ❌ Insecure environment variable values in production:
#    - JWT_SECRET (using default/insecure value)
```

**Test 4: Sample data not inserted in production**
```bash
# Start server in production mode
NODE_ENV=production npm start

# Check logs
# Expected: No "Sample data inserted" message
```

### Automated Security Tests

```typescript
// tests/security/authentication.test.ts

describe('Authentication Security', () => {
  test('mock token is rejected', async () => {
    const response = await request(app)
      .get('/api/dashboard')
      .set('Authorization', 'Bearer mock-jwt-token-system-owner');

    expect(response.status).toBe(401);
    expect(response.body.message).toContain('Invalid or expired token');
  });

  test('missing JWT_SECRET prevents server start', () => {
    delete process.env.JWT_SECRET;

    expect(() => {
      EnvironmentValidator.validate();
    }).toThrow('Missing required environment variables');
  });

  test('default JWT_SECRET rejected in production', () => {
    process.env.NODE_ENV = 'production';
    process.env.JWT_SECRET = 'dev_jwt_secret_change_in_production';

    expect(() => {
      EnvironmentValidator.validate();
    }).toThrow('Insecure environment variable values');
  });
});
```

---

## Definition of Done

- [x] Mock authentication token completely removed
- [x] Environment variable validation implemented
- [x] Server fails to start with missing/invalid env vars
- [x] Development-only code guarded by NODE_ENV checks
- [x] Security audit completed (no hardcoded credentials)
- [x] Manual security tests passed
- [x] Automated security tests written and passing
- [x] Documentation updated with security guidelines
- [x] Code reviewed by second developer
- [x] Penetration test confirms no bypass vulnerabilities

---

## Risks & Mitigation

### Risk 1: Breaking Existing Tests
**Probability**: High (70%)
**Impact**: Medium - test suite fails after removing mock token
**Mitigation**:
- Create test fixture for JWT generation BEFORE removing mock token
- Update all tests to use fixture in same commit
- Run full test suite before committing

### Risk 2: Breaking Development Workflow
**Probability**: Medium (40%)
**Impact**: Medium - developers can't run app locally
**Mitigation**:
- Update `.env.example` with clear instructions
- Test startup in fresh clone of repository
- Add helpful error messages for missing variables
- Document setup process in README

---

## Follow-up Actions

**After completing this story**:
1. Run penetration test to verify no other bypasses
2. Set up security scanning in CI/CD (Story 11.7)
3. Implement secrets rotation strategy (Story 11.9)
4. Add security monitoring and alerting (Story 11.8)

---

**Created**: 2025-10-18
**Story Owner**: Development Team
**Last Updated**: 2025-10-18
**Security Review Required**: Yes