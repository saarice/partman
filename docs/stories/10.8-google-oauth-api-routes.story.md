# Story 10.8: Google OAuth API Routes

**Story ID**: 10.8
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P0 (Blocker)
**Effort**: 8 Story Points

## Story
**As a** user
**I want** Google OAuth login endpoints
**So that** I can complete the OAuth flow and login

## Acceptance Criteria
1. Create POST /api/auth/google/url endpoint (generates OAuth URL)
2. Create POST /api/auth/google/callback endpoint (exchanges code for tokens)
3. POST /api/auth/google/url accepts state and codeChallenge in body
4. POST /api/auth/google/callback accepts code and codeVerifier in body
5. Callback endpoint returns same response format as /api/auth/login
6. If OAuth email exists, links to existing user and logs in
7. If OAuth email doesn't exist, creates new user with role='viewer'
8. Creates oauth_providers record on successful OAuth login
9. Returns user object, accessToken, refreshToken, expiresIn
10. Rate limit: 10 requests per 15 minutes per IP

## Technical Notes
**POST /api/auth/google/url**
```typescript
router.post('/google/url', asyncHandler(async (req: Request, res: Response) => {
  const { state, codeChallenge } = req.body;
  const url = await oauthService.getGoogleAuthUrl(state, codeChallenge);
  res.json({ status: 'success', data: { authUrl: url } });
}));
```

**POST /api/auth/google/callback**
```typescript
router.post('/google/callback', asyncHandler(async (req: Request, res: Response) => {
  const { code, codeVerifier } = req.body;
  const result = await oauthService.handleGoogleCallback(code, codeVerifier);
  res.json({
    status: 'success',
    data: {
      user: result.user,
      accessToken: result.tokens.accessToken,
      refreshToken: result.tokens.refreshToken,
      expiresIn: result.tokens.expiresIn
    }
  });
}));
```

## Tasks
- [ ] Add POST /api/auth/google/url endpoint
- [ ] Add POST /api/auth/google/callback endpoint
- [ ] Validate state and codeChallenge in /url endpoint
- [ ] Validate code and codeVerifier in /callback endpoint
- [ ] Call oauthService methods from routes
- [ ] Return consistent response format with login endpoint
- [ ] Add rate limiting (10 req/15min)
- [ ] Add error handling for OAuth failures
- [ ] Write unit tests for both endpoints
- [ ] Test with Postman/Thunder Client

## Testing
- [ ] POST /google/url returns valid Google OAuth URL
- [ ] OAuth URL includes state and code_challenge
- [ ] POST /google/callback with valid code returns tokens
- [ ] Callback creates new user if email doesn't exist
- [ ] Callback links to existing user if email exists
- [ ] oauth_providers record created on success
- [ ] Rate limiting blocks after 10 requests
- [ ] Invalid code returns 401 error
- [ ] Response format matches /api/auth/login

## Definition of Done
- Both endpoints functional and tested
- Rate limiting implemented
- Response format consistent with existing auth endpoints
- All tests passing

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### File List
- `apps/api/src/routes/auth.ts`

### Change Log
[To be filled during implementation]
