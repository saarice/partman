# Story 10.12: Registration Page for Invited Users

**Story ID**: 10.12
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P1 (High)
**Effort**: 8 Story Points

## Story
**As an** invited user
**I want** a registration page to set my password
**So that** I can complete my account setup

## Acceptance Criteria
1. Create /register route (public access)
2. Page extracts token from URL query params (?token=xyz)
3. On mount, call GET /api/invitations/validate/:token
4. If token invalid/expired, show error message and "Request New Invitation" link
5. If token valid, display registration form
6. Form shows: Email (pre-filled, disabled), First Name, Last Name, Password, Confirm Password
7. Form displays invited role: "You're joining as a {role}"
8. Password validation: min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char
9. Submit calls POST /api/invitations/accept with token, password, firstName, lastName
10. On success, auto-login and redirect to /dashboard
11. On error, display error message

## Technical Notes
**RegisterPage.tsx:**
```typescript
export const RegisterPage: React.FC = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const token = searchParams.get('token');

  const [invitation, setInvitation] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    password: '',
    confirmPassword: ''
  });

  useEffect(() => {
    if (!token) {
      setError('Invalid invitation link');
      setLoading(false);
      return;
    }

    validateToken();
  }, [token]);

  const validateToken = async () => {
    try {
      const { data } = await api.get(`/invitations/validate/${token}`);
      setInvitation(data);
    } catch (err) {
      setError(err.response?.data?.message || 'Invalid or expired invitation');
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (formData.password !== formData.confirmPassword) {
      setError('Passwords do not match');
      return;
    }

    try {
      const { data } = await api.post('/invitations/accept', {
        token,
        firstName: formData.firstName,
        lastName: formData.lastName,
        password: formData.password
      });

      // Auto-login
      authStore.login(data.accessToken, data.refreshToken, data.user);
      navigate('/dashboard');
    } catch (err) {
      setError(err.response?.data?.message || 'Registration failed');
    }
  };

  if (loading) return <CircularProgress />;

  if (error && !invitation) {
    return (
      <Box>
        <Alert severity="error">{error}</Alert>
        <Typography>Please contact your administrator for a new invitation.</Typography>
      </Box>
    );
  }

  return (
    <Box>
      <Typography variant="h4">Complete Your Registration</Typography>
      <Typography variant="body2" color="text.secondary">
        You're joining as a <strong>{invitation.role}</strong>
      </Typography>

      <form onSubmit={handleSubmit}>
        <TextField
          label="Email"
          value={invitation.email}
          disabled
          fullWidth
          margin="normal"
        />
        <TextField
          label="First Name"
          value={formData.firstName}
          onChange={(e) => setFormData({...formData, firstName: e.target.value})}
          required
          fullWidth
          margin="normal"
        />
        <TextField
          label="Last Name"
          value={formData.lastName}
          onChange={(e) => setFormData({...formData, lastName: e.target.value})}
          required
          fullWidth
          margin="normal"
        />
        <TextField
          label="Password"
          type="password"
          value={formData.password}
          onChange={(e) => setFormData({...formData, password: e.target.value})}
          required
          fullWidth
          margin="normal"
          helperText="Min 8 characters, 1 uppercase, 1 lowercase, 1 number, 1 special char"
        />
        <TextField
          label="Confirm Password"
          type="password"
          value={formData.confirmPassword}
          onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
          required
          fullWidth
          margin="normal"
        />

        {error && <Alert severity="error">{error}</Alert>}

        <Button type="submit" variant="contained" fullWidth>
          Complete Registration
        </Button>
      </form>
    </Box>
  );
};
```

## Tasks
- [ ] Create RegisterPage component
- [ ] Extract token from URL query params
- [ ] Call GET /api/invitations/validate/:token on mount
- [ ] Display error page for invalid/expired tokens
- [ ] Display registration form for valid tokens
- [ ] Pre-fill and disable email field
- [ ] Display invited role
- [ ] Add first name and last name fields
- [ ] Add password and confirm password fields
- [ ] Implement password validation
- [ ] Implement confirm password matching
- [ ] Call POST /api/invitations/accept on submit
- [ ] Auto-login after successful registration
- [ ] Redirect to /dashboard on success
- [ ] Display error messages
- [ ] Add route to App.tsx
- [ ] Test mobile responsiveness
- [ ] Add loading state during token validation

## Testing
- [ ] Valid token displays registration form
- [ ] Invalid token displays error message
- [ ] Expired token displays error message
- [ ] Email pre-filled and disabled
- [ ] Role displayed correctly
- [ ] Password validation enforces rules
- [ ] Confirm password matching works
- [ ] Form submission creates user
- [ ] Auto-login after registration
- [ ] Redirect to dashboard works
- [ ] Error messages display correctly
- [ ] Mobile responsive

## Definition of Done
- Registration page functional
- Token validation working
- Password validation enforced
- Auto-login and redirect working
- Error handling complete
- Mobile responsive

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### File List
- `apps/web/src/pages/Auth/RegisterPage.tsx`
- `apps/web/src/App.tsx` (add route)

### Change Log
[To be filled during implementation]
