# Story 11.5: Add Comprehensive Test Coverage for Business Logic

## Status
Ready for Development

## Epic
Epic 11: Production Readiness & Technical Debt Resolution

## Priority
🟡 **HIGH** - Quality Assurance

## Story Points
21 points (4-5 days)

---

## Story

**As a** Development Team
**I want** comprehensive test coverage for all critical business logic
**So that** we can confidently deploy to production knowing commission calculations, authentication, and core features work correctly

---

## Context

**Current Coverage**: ~8.5% (7 test files for 82 source files)

**Target Coverage**:
- Business logic: >80%
- Overall: >60%

**Critical Untested Areas**:
- ❌ Commission calculation engine (financial impact!)
- ❌ Authentication/authorization flows
- ❌ API endpoints (opportunities, partners, dashboard)
- ❌ Database queries
- ❌ State management (Zustand stores)

---

## Acceptance Criteria

### 1. Commission Calculation Tests (HIGHEST PRIORITY)
- [ ] Referral commission tests (15% default)
- [ ] Reseller commission tests (30% default)
- [ ] MSP commission tests (25% default)
- [ ] Custom commission rate tests
- [ ] Edge cases: $0 deals, max values, decimal precision
- [ ] Commission cap/floor validation
- [ ] Multi-currency commission tests

### 2. Authentication & Authorization Tests
- [ ] Login flow tests (success, invalid credentials, locked account)
- [ ] Token generation and validation
- [ ] Token refresh mechanism
- [ ] Password hashing verification
- [ ] Role-based access control tests
- [ ] Protected route authorization

### 3. API Endpoint Tests
- [ ] GET /api/opportunities (filtering, sorting, pagination)
- [ ] POST /api/opportunities (validation, authorization)
- [ ] PUT /api/opportunities/:id
- [ ] DELETE /api/opportunities/:id
- [ ] All partner endpoints
- [ ] All dashboard endpoints
- [ ] Error handling (400, 401, 403, 404, 500)

### 4. Database Tests
- [ ] Query parameterization (SQL injection prevention)
- [ ] Transaction handling
- [ ] Connection pooling
- [ ] Data validation

### 5. Coverage Thresholds Met
- [ ] Commission calculations: >90%
- [ ] Authentication: >85%
- [ ] API endpoints: >75%
- [ ] Overall: >60%

---

## Priority Testing Order

### Week 1: Critical Business Logic

**Day 1-2: Commission Calculations**
```typescript
// tests/business-logic/commissions.test.ts

describe('Commission Calculations', () => {
  describe('Referral Commissions', () => {
    test('calculates 15% for standard referral', () => {
      const dealValue = 100000;
      const commission = calculateCommission(dealValue, {
        type: 'referral',
        rate: 15
      });

      expect(commission).toBe(15000);
      expect(commission).toBeLessThanOrEqual(dealValue);
    });

    test('applies custom referral rate', () => {
      const commission = calculateCommission(50000, {
        type: 'referral',
        rate: 20
      });

      expect(commission).toBe(10000);
    });

    test('handles decimal precision correctly', () => {
      const commission = calculateCommission(99.99, {
        type: 'referral',
        rate: 15.5
      });

      expect(commission).toBeCloseTo(15.50, 2);
    });
  });

  describe('Reseller Commissions', () => {
    test('calculates 30% for standard reseller', () => {
      const commission = calculateCommission(200000, {
        type: 'reseller',
        rate: 30
      });

      expect(commission).toBe(60000);
    });

    test('applies volume tiers', () => {
      const commission = calculateCommission(500000, {
        type: 'reseller',
        tiers: [
          { min: 0, max: 100000, rate: 25 },
          { min: 100000, max: Infinity, rate: 35 }
        ]
      });

      expect(commission).toBeGreaterThan(125000);
    });
  });

  describe('Edge Cases', () => {
    test('handles zero deal value', () => {
      const commission = calculateCommission(0, { type: 'referral', rate: 15 });
      expect(commission).toBe(0);
    });

    test('rejects negative deal values', () => {
      expect(() => {
        calculateCommission(-1000, { type: 'referral', rate: 15 });
      }).toThrow('Deal value cannot be negative');
    });

    test('applies commission cap', () => {
      const commission = calculateCommission(1000000, {
        type: 'referral',
        rate: 30,
        cap: 200000
      });

      expect(commission).toBe(200000);
    });

    test('applies commission floor', () => {
      const commission = calculateCommission(100, {
        type: 'referral',
        rate: 10,
        floor: 1000
      });

      expect(commission).toBe(1000);
    });
  });
});
```

**Day 3-4: Authentication & Authorization**
```typescript
// tests/api/auth.test.ts

describe('Authentication', () => {
  test('successful login returns JWT token', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        email: 'admin@partman.com',
        password: 'password123'
      });

    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('accessToken');
    expect(response.body).toHaveProperty('refreshToken');
  });

  test('invalid credentials return 401', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        email: 'admin@partman.com',
        password: 'wrongpassword'
      });

    expect(response.status).toBe(401);
    expect(response.body.message).toContain('Invalid credentials');
  });

  test('token refresh works with valid refresh token', async () => {
    // Login first
    const loginRes = await request(app)
      .post('/api/auth/login')
      .send({ email: 'admin@partman.com', password: 'password123' });

    const refreshToken = loginRes.body.refreshToken;

    // Refresh token
    const refreshRes = await request(app)
      .post('/api/auth/refresh')
      .send({ refreshToken });

    expect(refreshRes.status).toBe(200);
    expect(refreshRes.body).toHaveProperty('accessToken');
  });
});

describe('Authorization', () => {
  test('system_owner can access all resources', async () => {
    const token = generateTestToken({ role: 'system_owner' });

    const response = await request(app)
      .get('/api/partners')
      .set('Authorization', `Bearer ${token}`);

    expect(response.status).toBe(200);
  });

  test('team_member cannot access admin endpoints', async () => {
    const token = generateTestToken({ role: 'team_member' });

    const response = await request(app)
      .get('/api/admin/users')
      .set('Authorization', `Bearer ${token}`);

    expect(response.status).toBe(403);
  });
});
```

**Day 5: API Endpoints**
```typescript
// tests/api/opportunities.test.ts

describe('Opportunities API', () => {
  test('GET /api/opportunities returns list', async () => {
    const token = generateTestToken();

    const response = await request(app)
      .get('/api/opportunities')
      .set('Authorization', `Bearer ${token}`);

    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('opportunities');
    expect(Array.isArray(response.body.opportunities)).toBe(true);
  });

  test('POST /api/opportunities creates new opportunity', async () => {
    const token = generateTestToken();

    const newOpp = {
      partnerId: 'test-partner-id',
      customerName: 'Test Customer',
      dealValue: 50000,
      stage: 'lead'
    };

    const response = await request(app)
      .post('/api/opportunities')
      .set('Authorization', `Bearer ${token}`)
      .send(newOpp);

    expect(response.status).toBe(201);
    expect(response.body.opportunity).toHaveProperty('id');
    expect(response.body.opportunity.customerName).toBe('Test Customer');
  });

  test('PUT /api/opportunities/:id updates opportunity', async () => {
    const token = generateTestToken();

    // Create opportunity first
    const createRes = await createTestOpportunity();
    const oppId = createRes.body.opportunity.id;

    // Update it
    const response = await request(app)
      .put(`/api/opportunities/${oppId}`)
      .set('Authorization', `Bearer ${token}`)
      .send({ stage: 'demo' });

    expect(response.status).toBe(200);
    expect(response.body.opportunity.stage).toBe('demo');
  });

  test('filtering works correctly', async () => {
    const token = generateTestToken();

    const response = await request(app)
      .get('/api/opportunities?stage=lead&minValue=10000')
      .set('Authorization', `Bearer ${token}`);

    expect(response.status).toBe(200);
    response.body.opportunities.forEach(opp => {
      expect(opp.stage).toBe('lead');
      expect(opp.value).toBeGreaterThanOrEqual(10000);
    });
  });
});
```

---

## Test Utilities

**Create test fixtures**:
```typescript
// tests/fixtures/index.ts

export function generateTestToken(payload: Partial<TokenPayload> = {}) {
  return jwt.sign(
    {
      userId: payload.userId || 'test-user-id',
      email: payload.email || 'test@partman.com',
      role: payload.role || 'vp'
    },
    process.env.JWT_SECRET || 'test-secret',
    { expiresIn: '1h' }
  );
}

export async function createTestOpportunity(data: Partial<Opportunity> = {}) {
  return request(app)
    .post('/api/opportunities')
    .set('Authorization', `Bearer ${generateTestToken()}`)
    .send({
      partnerId: data.partnerId || 'test-partner-id',
      customerName: data.customerName || 'Test Customer',
      dealValue: data.dealValue || 50000,
      stage: data.stage || 'lead',
      ...data
    });
}
```

---

## Definition of Done

- [x] Commission calculation tests: >90% coverage
- [x] Authentication tests: >85% coverage
- [x] API endpoint tests: >75% coverage
- [x] Overall coverage: >60%
- [x] All tests passing
- [x] Test execution: <5 minutes
- [x] CI/CD integration configured
- [x] Test documentation complete

---

**Created**: 2025-10-18
**Story Owner**: Development Team
**Last Updated**: 2025-10-18