# Story 10.1: Database Schema for OAuth & Invitations

**Story ID**: 10.1
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P0 (Blocker)
**Effort**: 8 Story Points

## Story
**As a** developer
**I want** database tables for OAuth providers, user invitations, and activity logs
**So that** the system can support Google authentication and user invitation workflows

## Acceptance Criteria
1. Migration 004_add_oauth.sql creates oauth_providers table with indexes
2. Migration 005_add_invitations.sql creates user_invitations table
3. Migration 006_update_users.sql adds: profile_picture_url, last_login_at, registration_method
4. Migration 007_update_refresh_tokens.sql adds remember_me column, removes unique constraint
5. Migration 008_add_activity_logs.sql creates user_activity_logs table
6. All migrations run successfully with `npm run migrate`
7. Database indexes created for optimal query performance

## Technical Notes
**New Tables:**
- oauth_providers: Store Google account linkages (provider, provider_user_id, user_id FK)
- user_invitations: Track invitation lifecycle (email, token, status, expires_at)
- user_activity_logs: Audit trail (user_id, action, method, ip_address, user_agent)

**Updated Tables:**
- users: Add profile_picture_url, last_login_at, registration_method
- refresh_tokens: Add remember_me column, remove unique constraint on user_id

**Indexes:**
- oauth_providers: (provider, provider_user_id), (user_id)
- user_invitations: (token), (email), (status, expires_at)
- user_activity_logs: (user_id, created_at)
- refresh_tokens: (user_id), (token)

## Tasks
- [ ] Create migration 004_add_oauth.sql with oauth_providers table
- [ ] Create migration 005_add_invitations.sql with user_invitations table
- [ ] Create migration 006_update_users.sql to add new columns
- [ ] Create migration 007_update_refresh_tokens.sql to modify constraints
- [ ] Create migration 008_add_activity_logs.sql with user_activity_logs table
- [ ] Add all indexes for performance optimization
- [ ] Test migrations on clean database
- [ ] Test migrations on existing database with data
- [ ] Verify all foreign keys and constraints work correctly
- [ ] Run EXPLAIN ANALYZE on key queries to verify index usage

## Testing
- [ ] Run `npm run migrate` on clean database - succeeds
- [ ] Run `npm run migrate` on existing database - succeeds without data loss
- [ ] Verify oauth_providers.user_id FK cascade deletes work
- [ ] Verify user_invitations.invited_by FK works correctly
- [ ] Verify user_activity_logs.user_id FK cascade deletes work
- [ ] Test index performance with sample data (1000+ users)
- [ ] Verify unique constraints on oauth_providers(provider, provider_user_id)
- [ ] Verify unique constraint on user_invitations(email)

## Definition of Done
- All 5 migration files created and tested
- Migrations tested on clean database successfully
- Migrations tested on existing database with data successfully
- All foreign keys and constraints functional
- Indexes verified with EXPLAIN ANALYZE
- Migration rollback tested (if applicable)

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### Debug Log References
[To be filled during implementation]

### Completion Notes
- [ ] All migrations created
- [ ] All tests passed
- [ ] Database schema verified

### File List
- `apps/api/src/migrations/004_add_oauth.sql`
- `apps/api/src/migrations/005_add_invitations.sql`
- `apps/api/src/migrations/006_update_users.sql`
- `apps/api/src/migrations/007_update_refresh_tokens.sql`
- `apps/api/src/migrations/008_add_activity_logs.sql`

### Change Log
[To be filled during implementation]
