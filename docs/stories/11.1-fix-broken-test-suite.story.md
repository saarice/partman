# Story 11.1: Fix Broken Test Suite & Test Infrastructure

## Status
Ready for Development

## Epic
Epic 11: Production Readiness & Technical Debt Resolution

## Priority
üî¥ **CRITICAL** - Deployment Blocker

## Story Points
5 points (1-2 days)

---

## Story

**As a** Developer
**I want** a fully functional test suite with proper infrastructure
**So that** I can verify code changes don't break existing functionality and have confidence in deployments

---

## Context

**Current State** (2025-10-18 Analysis):
```bash
Test Results: 3 passed, 3 FAILED
‚úì commission should not exceed deal value
‚úì commission calculation accuracy for high-value deals
‚úó referral commission should be 15% by default
‚úó reseller commission should be 30% by default
‚úó commission calculation handles edge cases

Error: TypeError: expect(...).toBeValidCommissionRate is not a function
```

**Root Cause**:
- Custom test matcher `toBeValidCommissionRate()` is referenced but never defined
- Test setup file (`tests/setup.js`) exists but doesn't register custom matchers
- Jest configuration correct, but matcher extensions missing

**Impact**:
- Cannot run `npm run test` successfully
- CI/CD pipeline would fail
- No confidence in code changes
- Deployment blocked

---

## Acceptance Criteria

### 1. All Existing Tests Pass
- [ ] `npm run test` exits with code 0 (success)
- [ ] All 6 commission calculation tests pass
- [ ] Zero test failures reported
- [ ] Test execution completes in <10 seconds

### 2. Custom Test Matchers Implemented
- [ ] `toBeValidCommissionRate()` matcher defined in `tests/setup.js`
- [ ] Validates commission rate is between 0 and 100
- [ ] Provides clear error messages on failure
- [ ] Works with all existing test cases

### 3. Test Infrastructure Verified
- [ ] Jest configuration loads setup files correctly
- [ ] DOM environment setup (`tests/setup-dom.js`) works for React tests
- [ ] Node environment setup (`tests/setup.js`) works for API tests
- [ ] Coverage reporting generates successfully

### 4. Documentation Updated
- [ ] README updated with test running instructions
- [ ] Custom matcher usage documented
- [ ] Test setup process documented
- [ ] Coverage thresholds documented

---

## Tasks / Subtasks

### Task 1: Fix Custom Test Matchers (1-2 hours)
- [ ] Open `tests/setup.js`
- [ ] Add `expect.extend()` with custom matchers
- [ ] Implement `toBeValidCommissionRate()` matcher
- [ ] Test matcher with simple cases
- [ ] Verify all commission tests use matcher correctly

**Implementation**:
```javascript
// tests/setup.js
expect.extend({
  toBeValidCommissionRate(received) {
    const pass =
      typeof received === 'number' &&
      received >= 0 &&
      received <= 100;

    if (pass) {
      return {
        message: () =>
          `expected ${received} not to be a valid commission rate (0-100)`,
        pass: true,
      };
    } else {
      return {
        message: () =>
          `expected ${received} to be a valid commission rate (0-100), ` +
          `but received ${typeof received === 'number' ? 'out of range' : 'non-numeric'} value`,
        pass: false,
      };
    }
  },

  // Add other custom matchers as needed
  toBeWithinRange(received, floor, ceiling) {
    const pass = received >= floor && received <= ceiling;
    if (pass) {
      return {
        message: () =>
          `expected ${received} not to be within range ${floor} - ${ceiling}`,
        pass: true,
      };
    } else {
      return {
        message: () =>
          `expected ${received} to be within range ${floor} - ${ceiling}`,
        pass: false,
      };
    }
  },
});
```

### Task 2: Verify Test Execution (30 minutes)
- [ ] Run `npm run test` - should pass
- [ ] Run `npm run test:coverage` - should generate report
- [ ] Run `npm run test:unit` - should run unit tests only
- [ ] Verify no flaky tests (run 3 times)

**Verification Commands**:
```bash
# Run all tests
npm run test

# Expected output:
# PASS  tests/helpers/commission.test.js
#   Commission Calculations
#     ‚úì referral commission should be 15% by default
#     ‚úì reseller commission should be 30% by default
#     ‚úì commission should not exceed deal value
#     ‚úì commission calculation accuracy for high-value deals
#     ‚úì commission calculation handles edge cases
#
# Test Suites: X passed, X total
# Tests:       X passed, X total
# Time:        X.XXXs
```

### Task 3: Fix Any Additional Test Issues (1-2 hours)
- [ ] Review test output for warnings or deprecations
- [ ] Fix any timeout issues in async tests
- [ ] Ensure test isolation (no shared state between tests)
- [ ] Verify mock cleanup between tests

### Task 4: Update Documentation (30 minutes)
- [ ] Add "Running Tests" section to README
- [ ] Document custom matchers in testing guide
- [ ] Add troubleshooting section for common test errors
- [ ] Update developer onboarding docs with test setup

---

## Dev Notes

### File Locations
**Test Infrastructure**:
- `tests/setup.js` - Node environment setup, custom matchers
- `tests/setup-dom.js` - jsdom setup for React component tests
- `jest.config.js` - Jest configuration
- `package.json` - Test scripts

**Existing Tests**:
- `tests/helpers/commission.test.js` - Commission calculation tests (BROKEN)
- `apps/web/src/components/dashboard/__tests__/*.test.tsx` - Component tests
- `apps/web/src/services/__tests__/*.test.ts` - Service tests
- `apps/web/tests/*.spec.ts` - Playwright E2E tests

### Jest Configuration
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  setupFilesAfterEnv: ['<rootDir>/tests/setup.js'], // ‚Üê Loads custom matchers
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  projects: [
    {
      displayName: 'node',
      testEnvironment: 'node',
      setupFilesAfterEnv: ['<rootDir>/tests/setup.js']
    },
    {
      displayName: 'jsdom',
      testEnvironment: 'jsdom',
      setupFilesAfterEnv: ['<rootDir>/tests/setup-dom.js']
    }
  ]
};
```

### Common Test Patterns

**Testing Commission Calculations**:
```javascript
describe('Commission Calculations', () => {
  test('referral commission should be 15% by default', () => {
    const dealValue = 100000;
    const commissionRate = 15;
    const expectedCommission = dealValue * (commissionRate / 100);

    expect(expectedCommission).toBe(15000);
    expect(commissionRate).toBeValidCommissionRate(); // Custom matcher
  });

  test('commission should not exceed deal value', () => {
    const dealValue = 100000;
    const commission = calculateCommission(dealValue, 120); // Invalid: 120%

    expect(commission).toBeLessThanOrEqual(dealValue);
  });
});
```

### Testing Best Practices
1. **Isolation**: Each test should be independent
2. **Descriptive Names**: Test names explain what's being tested
3. **Arrange-Act-Assert**: Clear test structure
4. **Edge Cases**: Test boundaries and error conditions
5. **Fast Execution**: Keep tests under 100ms each

---

## Acceptance Testing

### Test Execution Validation
```bash
# 1. Clean install
rm -rf node_modules package-lock.json
npm install

# 2. Run tests
npm run test

# Expected: All tests pass, exit code 0

# 3. Run with coverage
npm run test:coverage

# Expected: Coverage report generated in coverage/

# 4. Verify no flaky tests (run 3 times)
for i in {1..3}; do npm run test || exit 1; done

# Expected: All 3 runs pass
```

### Success Criteria Checklist
- [ ] `npm run test` exits with code 0
- [ ] All 6 commission tests pass
- [ ] Coverage report generates without errors
- [ ] Tests execute in <10 seconds
- [ ] No warnings or errors in output
- [ ] Documentation updated in README

---

## Dependencies

**Prerequisite Stories**: None (this is the foundation)
**Blocks**:
- Story 11.5 (Add Comprehensive Test Coverage) - needs working infrastructure
- Story 11.7 (CI/CD Pipeline) - requires passing tests
- All future development - no commits without passing tests

**Related Stories**:
- Story 11.10 (Code Quality Improvements) - pre-commit hooks require working tests

---

## Risks & Mitigation

### Risk 1: Additional Hidden Test Issues
**Probability**: Medium (30%)
**Impact**: Low - extends timeline by 1-2 hours
**Mitigation**:
- Thoroughly review all test files
- Run tests with `--verbose` flag to see detailed output
- Check for console warnings during test execution

### Risk 2: Test Environment Inconsistencies
**Probability**: Low (10%)
**Impact**: Medium - tests pass locally but fail in CI
**Mitigation**:
- Use exact Node version (20.x) in CI and locally
- Document required environment setup
- Test in clean environment (fresh Docker container)

---

## Definition of Done

- [x] All existing tests pass
- [x] Custom matchers implemented and documented
- [x] Coverage report generates successfully
- [x] README updated with test instructions
- [x] Tests verified in clean environment
- [x] No console warnings during test execution
- [x] Code committed with descriptive commit message
- [x] Tests pass in CI environment (if CI exists)

---

## Notes

**Time Estimate**: 1-2 hours implementation + 30 minutes documentation = ~2.5 hours total

**Quick Win**: This story provides immediate value by unblocking all future testing work. Should be completed FIRST before any other development.

**Follow-up**: After completing this story, immediately proceed to Story 11.2 (Security Vulnerabilities) and Story 11.3 (Connect Frontend to APIs) to remove remaining deployment blockers.

---

**Created**: 2025-10-18
**Story Owner**: Development Team
**Last Updated**: 2025-10-18