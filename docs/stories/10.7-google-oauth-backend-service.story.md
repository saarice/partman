# Story 10.7: Google OAuth Backend Service

**Story ID**: 10.7
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P0 (Blocker)
**Effort**: 13 Story Points

## Story
**As a** user
**I want** to login with my Google account
**So that** I can access the system without creating a password

## Acceptance Criteria
1. Create `apps/api/src/services/oauthService.ts`
2. Implement `getGoogleAuthUrl(state, codeChallenge)` method
3. Implement `exchangeCodeForTokens(code, codeVerifier)` method
4. Implement `getUserProfile(accessToken)` method
5. Implement `findOrCreateUser(googleProfile)` method
6. Use googleapis npm package for Google API calls
7. OAuth URL includes scopes: openid, email, profile
8. PKCE code_challenge and code_verifier for enhanced security
9. If email exists, links OAuth to existing user
10. If email doesn't exist, creates new user with role='viewer'
11. Unit tests mock Google API calls

## Technical Notes
- Install: `npm install googleapis`
- PKCE: SHA256 hash of code_verifier = code_challenge
- Scopes: openid, email, profile (minimal)
- Don't store Google access tokens long-term
- Create oauth_providers record with provider='google'

## Tasks
- [ ] Install googleapis npm package
- [ ] Create oauthService.ts with OAuth2 client
- [ ] Implement getGoogleAuthUrl with PKCE
- [ ] Implement exchangeCodeForTokens
- [ ] Implement getUserProfile
- [ ] Implement findOrCreateUser logic
- [ ] Handle email exists (link to existing user)
- [ ] Handle email doesn't exist (create new user as viewer)
- [ ] Write unit tests with mocked Google API
- [ ] Add environment variable validation

## Testing
- [ ] getGoogleAuthUrl generates valid OAuth URL
- [ ] OAuth URL includes correct scopes and PKCE
- [ ] exchangeCodeForTokens returns valid tokens
- [ ] getUserProfile returns user data
- [ ] findOrCreateUser links existing user correctly
- [ ] findOrCreateUser creates new viewer user
- [ ] Unit tests with mocked Google API pass
- [ ] Integration tests with Google OAuth sandbox

## Definition of Done
- OAuth service fully functional
- PKCE security implemented
- All tests passing
- Environment variables documented

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### File List
- `apps/api/src/services/oauthService.ts`
- `apps/api/package.json` (add googleapis)

### Change Log
[To be filled during implementation]
