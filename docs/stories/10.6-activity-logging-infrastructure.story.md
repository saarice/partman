# Story 10.6: Activity Logging Infrastructure

**Story ID**: 10.6
**Epic**: 10 - Authentication & Authorization Enhancement
**Status**: Ready for Development
**Priority**: P2 (Medium)
**Effort**: 5 Story Points

## Story
**As a** system owner
**I want** activity logging for all auth events
**So that** I can audit user access and detect security issues

## Acceptance Criteria
1. Create `apps/api/src/services/activityLogService.ts`
2. Service exports `logActivity(userId, action, method, ip, userAgent)` method
3. Actions tracked: login_success, login_failed, logout, password_changed, oauth_linked, role_changed
4. Auth service logs all login attempts (success and failure)
5. Failed login attempts logged with email (not just user_id)
6. Service handles errors gracefully (logging failure doesn't break main flow)

## Tasks
- [ ] Create activityLogService.ts with logActivity method
- [ ] Implement getActivityLogs query method
- [ ] Add logging to authService for all auth events
- [ ] Log failed login attempts with email in metadata
- [ ] Handle logging errors gracefully (try/catch, don't throw)
- [ ] Write unit tests for logging service
- [ ] Test query performance with sample data

## Testing
- [ ] All auth actions logged successfully
- [ ] Logs include IP and user agent
- [ ] Failed login attempts tracked with email
- [ ] Query performance < 50ms for recent 50 logs
- [ ] Logging errors don't break main operations
- [ ] getActivityLogs returns correct data format

## Definition of Done
- All auth actions logged
- Query performance acceptable
- Tests verify logging doesn't break on DB errors
- Failed login attempts include email

## Agent Model Used
[To be filled by dev agent]

## Dev Agent Record

### File List
- `apps/api/src/services/activityLogService.ts`
- `apps/api/src/services/authService.ts` (updated)

### Change Log
[To be filled during implementation]
