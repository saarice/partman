<!DOCTYPE html>
<html>
<head>
    <title>Debug Kanban Drag Drop</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .debug-panel { background: #f5f5f5; padding: 15px; margin: 10px 0; }
        .column { border: 1px solid #ccc; width: 200px; min-height: 100px; margin: 10px; display: inline-block; vertical-align: top; }
        .card { background: white; padding: 10px; margin: 5px; cursor: move; border: 1px solid #ddd; }
        .header { font-weight: bold; padding: 10px; background: #eee; }
        .count { color: blue; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
    <h1>Debug Kanban Drag Drop Issue</h1>

    <div class="debug-panel">
        <h2>Debug Output</h2>
        <div id="debug-output"></div>
    </div>

    <div class="kanban">
        <div class="column">
            <div class="header">
                Lead <span class="count" id="lead-count">0</span>
            </div>
            <div class="column-body" id="lead-column">
                <div class="card" data-opportunity-id="opp1">Opportunity 1 - $100k</div>
                <div class="card" data-opportunity-id="opp2">Opportunity 2 - $200k</div>
            </div>
        </div>

        <div class="column">
            <div class="header">
                Demo <span class="count" id="demo-count">0</span>
            </div>
            <div class="column-body" id="demo-column">
                <div class="card" data-opportunity-id="opp3">Opportunity 3 - $300k</div>
            </div>
        </div>

        <div class="column">
            <div class="header">
                POC <span class="count" id="poc-count">0</span>
            </div>
            <div class="column-body" id="poc-column">
            </div>
        </div>
    </div>

    <script>
        // Mock data similar to the real application
        let opportunities = [
            { id: 'opp1', stage: 'lead', dealValue: 100000 },
            { id: 'opp2', stage: 'lead', dealValue: 200000 },
            { id: 'opp3', stage: 'demo', dealValue: 300000 }
        ];

        const stageMapping = {
            'lead-column': 'lead',
            'demo-column': 'demo',
            'poc-column': 'poc'
        };

        function debug(message) {
            const output = document.getElementById('debug-output');
            output.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        function updateCounts() {
            debug('üîß updateCounts called');

            // Count opportunities in each stage
            const counts = {
                lead: opportunities.filter(opp => opp.stage === 'lead').length,
                demo: opportunities.filter(opp => opp.stage === 'demo').length,
                poc: opportunities.filter(opp => opp.stage === 'poc').length
            };

            debug('üìä Counts: ' + JSON.stringify(counts));

            // Update DOM
            document.getElementById('lead-count').textContent = counts.lead;
            document.getElementById('demo-count').textContent = counts.demo;
            document.getElementById('poc-count').textContent = counts.poc;

            debug('‚úÖ DOM updated with new counts');
        }

        function updateOpportunityModel(opportunityId, newStage) {
            debug(`üìù Updating ${opportunityId} to stage ${newStage}`);

            const opportunity = opportunities.find(opp => opp.id === opportunityId);
            if (opportunity) {
                const oldStage = opportunity.stage;
                opportunity.stage = newStage;
                debug(`‚úÖ Updated ${opportunityId}: ${oldStage} ‚Üí ${newStage}`);
            } else {
                debug(`‚ùå Opportunity ${opportunityId} not found!`);
            }
        }

        // Initialize Sortable on each column
        ['lead-column', 'demo-column', 'poc-column'].forEach(columnId => {
            const element = document.getElementById(columnId);

            const sortable = new Sortable(element, {
                group: 'kanban-pipeline',
                animation: 150,
                onEnd: (evt) => {
                    const opportunityId = evt.item.dataset.opportunityId;
                    const fromColumnId = evt.from.id;
                    const toColumnId = evt.to.id;

                    debug(`üéØ DRAG END: ${opportunityId} from ${fromColumnId} to ${toColumnId}`);

                    if (fromColumnId === toColumnId) {
                        debug('üìç Same column - no update needed');
                        return;
                    }

                    const newStage = stageMapping[toColumnId];
                    if (!newStage) {
                        debug(`‚ùå Unknown target column: ${toColumnId}`);
                        return;
                    }

                    // Update model
                    updateOpportunityModel(opportunityId, newStage);

                    // Update counts
                    updateCounts();
                }
            });

            debug(`‚úÖ Sortable initialized for ${columnId}`);
        });

        // Initial count update
        updateCounts();

        debug('üöÄ Debug environment initialized');
    </script>
</body>
</html>